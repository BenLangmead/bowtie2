sudo: required
language: cpp
branches:
  only:
  - master
  - cleaner_parsing
  - scaling-old-parsing
  - batch_parsing
  - batch_parsing_output
  - blocked_input
  - bug_fixes
matrix:
  include:
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-4.9
            - libtbb-dev
            - zlib1g-dev
      env:
        - MATRIX_EVAL="CC=gcc-4.9 && CXX=g++-4.9"
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-8
            - libtbb-dev
            - zlib1g-dev
      env:
        - MATRIX_EVAL="CC=gcc-8 && CXX=g++-8 && CXXFLAGS='-fuse-ld=gold'"
    - os: linux
      addons:
        apt:
          sources:
            - llvm-toolchain-trusty-5.0
          packages:
            - clang-5.0
            - libtbb-dev
            - zlib1g-dev
      env:
        - MATRIX_EVAL="CC=clang-5.0 && CXX=clang++-5.0"
    # aarch64 - ARM 64-bit
    - name: aarch64
      install:
      - docker run --rm --privileged multiarch/qemu-user-static:register --reset
      - docker build --rm -t bowtie2 -f Dockerfile-aarch64 .
      script:
      # Ping stdout every 9 minutes or Travis kills build,
      # as travis_wait does not show the command output while processing.
      # https://docs.travis-ci.com/user/common-build-problems/#build-times-out-because-no-output-was-received
      - |
        while sleep 9m; do
        echo "====[ $SECONDS seconds still running ]===="
        done &
      # Suppress warnings to see the Travis log easily.
      - CXXFLAGS="-Wno-deprecated-declarations -Wno-misleading-indentation -Wno-narrowing -Wno-unused-function -Wno-unused-result"
      # Run "make all" as "make allall simple-test" exceeds the Travis maximum
      # time limit (50 minutes).
      # Set POPCNT_CAPABILITY=0 to avoid a build error.
      # NO_TBB=1 possibly saves the running time.
      - docker run --rm -e CXXFLAGS="$CXXFLAGS" -e POPCNT_CAPABILITY=0 -t bowtie2 make -s -j 4 all
before-install:
  - eval "${MATRIX_EVAL}"
cache: apt
addons:
  apt:
    packages:
      - libtbb-dev
      - zlib1g-dev
script: make allall && make simple-test
notifications:
  slack:
    secure: tfzT8N1fNV+oSV7tide9WrAj3ifs+LONJ3fCH1tUzexqrx23te4lE0oAj9C1cEMJ4evyRYwHNG8HZoLCOy8EfapqbWm6vgLIlkIBpeZ9E6f2jG6v0YuVDWWpqQC3qdGXCqWtHPjgs3i5OLsLwwQ/LItLoTqpBk2aYv+vGNs2F9g=
